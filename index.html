<!DOCTYPE html>
<html>

<head>
  <title>Anne Pro 2 Layout Configurator</title>
  <meta name="author" content="Stanley00">
  <meta name="copyright" content="Public Domain">
  <meta name="keywords" content="AnnePro2, Layout">
  <meta name="description" content="Layout generator for Anne Pro 2 keyboard">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8">
  <meta http-equiv="content-style-type" content="text/css">
  <meta http-equiv="expires" content="0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' ">
  <style type="text/css">
    body * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 20px;
    }

    .column {
      float: left;
      width: 50%;
    }

    .row:after {
      content: "";
      display: table;
      clear: both;
    }

    .keyboard-base {
      max-width: 2000px;
      padding: 20px;
      position: absolute;
      left: 50%;
      transform: translate(-50%, 0%);

      background-color: rgb(197, 197, 197);
      border-radius: 10px;
      display: grid;
      grid-template-columns: repeat(60, 12px);
      grid-template-rows: repeat(5, 63px);
      grid-gap: 5px
    }


    .keyboard-x {
      max-width: 2000px;
      padding: 20px;
      position: absolute;
      left: 50%;
      top: 555px;
      transform: translate(-50%, 0%);

      background-color: rgb(197, 197, 197);
      border-radius: 10px;
      display: grid;
      grid-template-columns: repeat(60, 12px);
      grid-template-rows: repeat(13, 55px);
      grid-gap: 5px
    }

    .key {
      background-color: rgb(243, 243, 243);
      border: 2px solid black;
      border-radius: 5px;
      grid-column: span 4;
      font-size: 20px;
      text-align: center;
      padding-top: 17px;
    }

    .key:hover {
      border: 1px solid #eeeeee;
    }

    .with_shift {
      padding-top: 7px;
      font-size: 17px;
    }

    .small_text {
      font-size: 17px;
    }

    .selected {
      background-color: #ee7777;
    }

    .u125 {
      grid-column: span 5;
    }

    .u150 {
      grid-column: span 6;
    }

    .u175 {
      grid-column: span 7;
    }

    .u2 {
      grid-column: span 8;
    }

    .u225 {
      grid-column: span 9;
    }

    .u250 {
      grid-column: span 10;
    }

    .u275 {
      grid-column: span 11;
    }

    .u625 {
      grid-column: span 25;
    }
  </style>
</head>

<body>
  <center>
    <h1>Anne Pro 2 Layout Configurator</h1> <br />
    <input type="Button" id='layer0Btn' value="Default" onClick="displayLayer(0)" />
    <input type="Button" id='layer1Btn' value="FN1" onClick="displayLayer(1)" />
    <input type="Button" id='layer2Btn' value="FN2" onClick="displayLayer(2)" />
    <input type="Button" id='layer3Btn' value="TAPS" onClick="displayLayer(3)" />
    <input type='Button' value="Load" onClick="loadFile()" />
    <input type='file' id="uploadAnchorElem" style="display:none" />
    <input id="layoutname" />
    <a id="downloadAnchorElem" style="display:none"></a>
    <input type="button" value="Save" onClick="saveAnneLayout()" />
    <a href="https://github.com/Stanley00/anne-pro2-layout-configurator" target="_blank" title="1. Select Layer on the left
2. Click the key needed to be changed
3. Click the key code at the bottom
4. Save the file and import into ObinsKit application
5. ???
6. Profit
">Help</a>
  </center>
  <br />
  <div class="keyboard-base" id="layout">
    <div class="key">~</div>
    <div class="key">1</div>
    <div class="key">2</div>
    <div class="key">3</div>
    <div class="key">4</div>
    <div class="key">5</div>
    <div class="key">6</div>
    <div class="key">7</div>
    <div class="key">8</div>
    <div class="key">9</div>
    <div class="key">0</div>
    <div class="key">-</div>
    <div class="key">+</div>
    <div class="key u2">Delete</div>
    <div class="key u150">Tab</div>
    <div class="key">Q</div>
    <div class="key">w</div>
    <div class="key">E</div>
    <div class="key">R</div>
    <div class="key">T</div>
    <div class="key">Y</div>
    <div class="key">U</div>
    <div class="key">I</div>
    <div class="key">O</div>
    <div class="key">P</div>
    <div class="key">[</div>
    <div class="key">]</div>
    <div class="key u150">\</div>
    <div class="key u175">CapsLock</div>
    <div class="key">A</div>
    <div class="key">S</div>
    <div class="key">D</div>
    <div class="key">F</div>
    <div class="key">G</div>
    <div class="key">H</div>
    <div class="key">J</div>
    <div class="key">K</div>
    <div class="key">L</div>
    <div class="key">;</div>
    <div class="key">'</div>
    <div class="key u225">Enter</div>
    <div class="key u225">Shift</div>
    <div class="key">Z</div>
    <div class="key">X</div>
    <div class="key">C</div>
    <div class="key">V</div>
    <div class="key">B</div>
    <div class="key">N</div>
    <div class="key">M</div>
    <div class="key">,</div>
    <div class="key">.</div>
    <div class="key">/</div>
    <div class="key u275">Shift</div>
    <div class="key u125">Ctrl</div>
    <div class="key u125">Alt</div>
    <div class="key u125">Super</div>
    <div class="key u625">Space</div>
    <div class="key u125">Alt</div>
    <div class="key u125">Super</div>
    <div class="key u125">Menu</div>
    <div class="key u125">Ctrl</div>
  </div>

  <div class="keyboard-x" id="keycodes">
  </div>


  <script type="text/javascript">
    var LayerData = [];

    function displayLayerData(layout) {
      LayerData[0] = layout.data.layer0;
      LayerData[1] = layout.data.layer1;
      LayerData[2] = layout.data.layer2;
      LayerData[3] = layout.data.taps;
    }

    displayLayerData(
      // Exported from default QWERTY profile
      {
        "name": "QWERTY",
        "device": 1,
        "model": 5,
        "type": "layout",
        "data": {
          "layer0": [41, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 45, 46, 42, 43, 20, 26, 8, 21, 23, 28, 24, 12, 18,
            19, 47, 48, 49, 57, 4, 22, 7, 9, 10, 11, 13, 14, 15, 51, 52, 40, 225, 29, 27, 6, 25, 5, 17, 16, 54, 55,
            56, 229, 224, 227, 226, 44, 230, 192, 193, 228
          ],
          "layer1": [53, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 0, 0, 0, 82, 0, 0, 0, 0, 0, 82, 0, 70, 74,
            77, 0, 0, 80, 81, 79, 0, 0, 0, 80, 81, 79, 75, 78, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 73, 76, 0, 0, 0, 0, 0,
            0, 192, 193, 0
          ],
          "layer2": [0, 200, 201, 202, 203, 0, 0, 0, 0, 241, 240, 244, 243, 0, 0, 0, 82, 0, 0, 0, 0, 0, 82, 0, 70, 74,
            77, 0, 0, 80, 81, 79, 0, 0, 0, 80, 81, 79, 75, 78, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 73, 76, 0, 0, 0, 0, 0,
            0, 192, 193, 0
          ],
          "taps": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 82, 0, 0, 0, 0, 0, 80, 81, 79
          ]
        },
        "crc": "cd9f84ea"
      }
    );

    var selectedLayer = 0;

    const USB_HID_KEY_CODE = [
      '  ', '', '', '', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S',
      'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
      '!\n1', '@\n2', '#\n3', '$\n4', '%\n5', '^\n6', '&\n7', '*\n8', '(\n9', ')\n0',
      'Enter', 'ESC', 'Backspace', 'Tab', 'Space',
      '_\n-', '+\n=', '{\n[', '}\n]', '|\n\\', '~\n#', ':\n;', '"\n\'', '`~', '<\n,', '>\n.', '?\n/',
      'CapLock', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12',
      'Print\nScreen', 'Scroll\nLock', 'Pause', 'Insert', 'Home', 'Page\nUp', 'Delete', 'End', 'Page\nDown',
      'Right', 'Left', 'Down', 'Up',
      'NumLock', 'KP /', 'KP *', 'KP -', 'KP +', 'KP\nEnter',
      'KP 1', 'KP 2', 'KP 3', 'KP 4', 'KP 5', 'KP 6', 'KP 7', 'KP 8', 'KP 9', 'KP 0', 'KP .',
      '|*\n\\', 'COMP\n(APP)', 'POWER', 'KP =',
      'F13', 'F14', 'F15', 'F16', 'F17', 'F18', 'F19', 'F20', 'F21', 'F22', 'F23', 'F24',
      'Exec', 'Help', 'Menu', 'Select', 'Cancel', 'Redo', 'Undo', 'Cut', 'Copy', 'Paste', 'Find', 'Mute', 'Vol+',
      'Vol-',
      // Skip all rarely used keys, index 0x82~0xdf
    ];
    const USB_HID_KEY_CODE_EXTENDED_START_INDEX = 0xe0;
    const USB_HID_KEY_CODE_EXTENDED = [
      'LCtrl', 'LShift', 'LAlt', 'LMeta', 'RCtrl', 'RShift', 'RAlt', 'RMeta'
      // The following keys seems doesn't work
      //, 'Play', 'StopCD', 'Prev', 'Next', 'EjectCD', 'MVol+', 'MVol-', 'MMute', 'WWW', 'WWW\nBack', 'WWW\nForward', 'WWW\nStop', 'WWW\nFind', 'WWW\nScrollUp', 'WWW\nScrollDown', 'Sleep', 'Coffee', 'Refresh', 'Calc'	
    ];

    USB_HID_KEY_CODE_EXTENDED.forEach((c, i) => USB_HID_KEY_CODE[USB_HID_KEY_CODE_EXTENDED_START_INDEX + i] = c);
    //For Anne Pro 2 special key
    USB_HID_KEY_CODE[240] = 'AnneBL\nToogle';
    USB_HID_KEY_CODE[241] = 'AnneBL\nCycle';
    USB_HID_KEY_CODE[243] = 'Anne\nBL+';
    USB_HID_KEY_CODE[244] = 'Anne\nBL-';
    USB_HID_KEY_CODE[246] = 'Anne\n%BAT';
    USB_HID_KEY_CODE[207] = 'Anne\nGamePad';
    USB_HID_KEY_CODE[200] = 'BT1';
    USB_HID_KEY_CODE[201] = 'BT2';
    USB_HID_KEY_CODE[202] = 'BT3';
    USB_HID_KEY_CODE[203] = 'BT4';
    USB_HID_KEY_CODE[192] = 'FN1';
    USB_HID_KEY_CODE[193] = 'FN2';
    USB_HID_KEY_CODE[194] = 'FN3';
    USB_HID_KEY_CODE[168] = 'Anne\nMute';
    USB_HID_KEY_CODE[169] = 'Anne\nVol+';
    USB_HID_KEY_CODE[170] = 'Anne\nVol-';
    USB_HID_KEY_CODE[171] = 'Anne\nPlay';
    USB_HID_KEY_CODE[172] = 'Anne\nPrev';
    USB_HID_KEY_CODE[173] = 'Anne\nNext';

    //FOR YOU, THE HACKER: Add more key codes here
    // Ex: USB_HID_KEY_CODE[255] = 'Text';

    HID_CODE_COMMENT = {
      100: 'Non-US \\|',
      104: 'XF86Tools',
      105: 'XF86Launch5',
      106: 'XF86Launch6',
      107: 'XF86Launch7',
      108: 'XF86Launch8',
      109: 'XF86Launch9',
      111: 'Mic Mute',
      112: 'Touchpad toogle',
      113: 'Touchpad On',
      114: 'Touchpad Off',
      194: 'Active Tap layer',
      200: 'Bluetooth Device 1',
      201: 'Bluetooth Device 2',
      202: 'Bluetooth Device 3',
      203: 'Bluetooth Device 4',
      207: 'Active game pad mode',
      240: 'Toogle Backlight On/Off',
      241: 'Next Backlight Effect',
      243: 'Increase Backlight Brightness',
      244: 'Decrease Backlight Brghtness',
      246: 'Anne battery percent',
    };

    function setKeyText(k, key_code, is_small) {
      text = USB_HID_KEY_CODE[key_code] || '';
      k.innerText = text;
      if (text.indexOf('\n') >= 0) {
        k.classList.add('with_shift');
      } else if (is_small && text.length > 4) {
        k.classList.add('small_text');
      } else {
        k.classList.remove('small_text');
        k.classList.remove('with_shift');
      }
    }


    function displayLayer(i) {
      document.getElementById("layer" + selectedLayer + "Btn").classList.remove("selected");
      selectedLayer = i;
      document.getElementById("layer" + selectedLayer + "Btn").classList.add("selected");

      LayerData[selectedLayer].forEach((code, index) =>
        setKeyText(document.querySelector("html body div#layout.keyboard-base div.key:nth-child(" + (index + 1) +
          ")"),
          code)
      );
    }


    function searchKeycode(text) {
      if (!text || text.trim() === '') return 0;
      var i = USB_HID_KEY_CODE.indexOf(text);
      if (i >= 0) return i;

      return 0;
    }

    var makeCRCTable = function () {
      var c;
      var crcTable = [];
      for (var n = 0; n < 256; n++) {
        c = n;
        for (var k = 0; k < 8; k++) {
          c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
        }
        crcTable[n] = c;
      }
      return crcTable;
    }

    var crc32 = function (str) {
      var crcTable = window.crcTable || (window.crcTable = makeCRCTable());
      var crc = 0 ^ (-1);

      for (var i = 0; i < str.length; i++) {
        crc = (crc >>> 8) ^ crcTable[(crc ^ str.charCodeAt(i)) & 0xFF];
      }

      return (crc ^ (-1)) >>> 0;
    };

    function loadFile() {
      var fileInput = document.getElementById('uploadAnchorElem');

      fileInput.addEventListener('change', function () {
        var file = fileInput.files[0];

        if (file.name.match(/\.(json)$/)) {
          var reader = new FileReader();

          reader.onload = function () {
            data = JSON.parse(reader.result);
            if (data.type !== 'layout') return;
            document.getElementById('layoutname').value = data.name;
            displayLayerData(data);
            displayLayer(selectedLayer);
          };
          reader.readAsText(file);
        }
      });

      fileInput.click();
    }

    function createAnneLayout(name) {
      const layoutTemplate = {
        name: name,
        device: 1,
        model: 5,
        type: 'layout',
        data: {
          layer0: LayerData[0],
          layer1: LayerData[1],
          layer2: LayerData[2],
          taps: LayerData[3]
        }
      };
      layoutTemplate.crc = crc32([
        layoutTemplate['name'],
        layoutTemplate['device'],
        layoutTemplate['model'],
        layoutTemplate['type'],
        JSON.stringify(layoutTemplate['data'])

      ].join('|')).toString(16);

      return layoutTemplate;
    }

    function saveAnneLayout() {
      const layoutname = document.getElementById('layoutname').value || 'Default';

      const file_name = layoutname + '.json';
      var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(createAnneLayout(layoutname)));
      var dlAnchorElem = document.getElementById('downloadAnchorElem');
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", file_name);
      dlAnchorElem.click();
    }
  </script>
  <script type="text/javascript">
    // Startup script
    document.querySelectorAll("div#layout.keyboard-base div.key").forEach((b, i) => {
      b.id = i;
      b.onclick = function () {
        document.querySelectorAll("div.key.selected").forEach(x =>
          x !== this && x.classList.remove("selected")
        );
        this.classList.toggle("selected");
      }.bind(b)

    });

    displayLayer(0);

    USB_HID_KEY_CODE.forEach(function (str) {
      if (!str || str === '') return;
      var iDiv = document.createElement('div');
      iDiv.className = 'key u125';
      const keyCode = searchKeycode(str);
      iDiv.title = HID_CODE_COMMENT[keyCode] || '';
      iDiv.onclick = function () {
        document.querySelectorAll("div.key.selected").forEach(x => LayerData[selectedLayer][x.id] = keyCode);

        displayLayer(selectedLayer);
      };
      setKeyText(iDiv, keyCode, true);
      document.querySelector("html body div#keycodes.keyboard-x").appendChild(iDiv);
    });
  </script>
</body>

</html>
